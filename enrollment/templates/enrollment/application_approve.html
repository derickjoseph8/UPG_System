{% extends 'base.html' %}
{% load static %}

{% block title %}Approve Application {{ application.application_id }} - UPG MIS{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-gavel"></i> Approve/Reject Application {{ application.application_id }}</h2>
                    <p class="text-muted">{{ application.first_name }} {{ application.last_name }}</p>
                </div>
                <div>
                    <a href="{% url 'enrollment:application_detail' application.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Application
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Application Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-file-alt"></i> Application Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Applicant:</strong> {{ application.first_name }} {{ application.last_name }}</p>
                            <p><strong>ID Number:</strong> {{ application.id_number }}</p>
                            <p><strong>Phone:</strong> {{ application.phone_number }}</p>
                            <p><strong>Village:</strong> {{ application.village.name }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Program:</strong> {{ application.program.name }}</p>
                            <p><strong>Status:</strong>
                                <span class="badge bg-warning">{{ application.get_status_display }}</span>
                            </p>
                            {% if application.screening_score %}
                            <p><strong>Screening Score:</strong>
                                <span class="badge {% if application.screening_passed %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ application.screening_score|floatformat:1 }}
                                </span>
                            </p>
                            {% endif %}
                            <p><strong>Submitted:</strong> {{ application.created_at|date:"Y-m-d" }}</p>
                        </div>
                    </div>

                    {% if application.screening_notes %}
                    <hr>
                    <p><strong>Screening Notes:</strong></p>
                    <p class="text-muted">{{ application.screening_notes }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Validation Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-shield-alt"></i> Validation Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ID Validated:</strong>
                                {% if application.id_validated %}
                                    <span class="text-success"><i class="fas fa-check-circle"></i> Yes</span>
                                {% elif application.id_validated == False %}
                                    <span class="text-danger"><i class="fas fa-times-circle"></i> No</span>
                                {% else %}
                                    <span class="text-muted">Pending</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Phone Validated:</strong>
                                {% if application.phone_validated %}
                                    <span class="text-success"><i class="fas fa-check-circle"></i> Yes</span>
                                {% elif application.phone_validated == False %}
                                    <span class="text-danger"><i class="fas fa-times-circle"></i> No</span>
                                {% else %}
                                    <span class="text-muted">Pending</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Decision Form -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-balance-scale"></i> Approval Decision</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="approvalForm">
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="form-label">Decision <span class="text-danger">*</span></label>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success btn-lg" onclick="setDecision('approve')">
                                    <i class="fas fa-thumbs-up"></i> Approve Application
                                </button>
                                <button type="button" class="btn btn-danger btn-lg" onclick="setDecision('reject')">
                                    <i class="fas fa-thumbs-down"></i> Reject Application
                                </button>
                            </div>
                        </div>

                        <div id="rejectionReasonDiv" style="display: none;" class="mb-4">
                            <label for="rejection_reason" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="rejection_reason" name="rejection_reason"
                                      rows="4" placeholder="Please provide a reason for rejection..."></textarea>
                        </div>

                        <input type="hidden" name="action" id="action">

                        <div class="mt-4" id="submitButtons" style="display: none;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Confirm Decision
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelDecision()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column - Guidelines -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-clipboard-list"></i> Approval Checklist</h5>
                </div>
                <div class="card-body small">
                    <h6>Before Approving, Verify:</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="check1">
                        <label class="form-check-label" for="check1">
                            Screening score meets program requirements
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="check2">
                        <label class="form-check-label" for="check2">
                            ID number has been validated
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="check3">
                        <label class="form-check-label" for="check3">
                            Phone number has been validated
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="check4">
                        <label class="form-check-label" for="check4">
                            Applicant meets all mandatory criteria
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="check5">
                        <label class="form-check-label" for="check5">
                            No duplicate applications exist
                        </label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> What Happens Next</h5>
                </div>
                <div class="card-body small">
                    <h6>If Approved:</h6>
                    <ul>
                        <li>Application status changes to "Approved"</li>
                        <li>Applicant can be enrolled into the program</li>
                        <li>Household record can be created</li>
                    </ul>

                    <h6 class="mt-3">If Rejected:</h6>
                    <ul>
                        <li>Application status changes to "Rejected"</li>
                        <li>Rejection reason is recorded</li>
                        <li>Applicant will be notified (if configured)</li>
                    </ul>

                    <div class="alert alert-warning small mt-3 mb-0">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Important:</strong> This decision cannot be easily reversed. Please review carefully.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function setDecision(decision) {
    document.getElementById('action').value = decision;
    document.getElementById('submitButtons').style.display = 'block';

    if (decision === 'reject') {
        document.getElementById('rejectionReasonDiv').style.display = 'block';
        document.getElementById('rejection_reason').required = true;
    } else {
        document.getElementById('rejectionReasonDiv').style.display = 'none';
        document.getElementById('rejection_reason').required = false;
    }
}

function cancelDecision() {
    document.getElementById('action').value = '';
    document.getElementById('submitButtons').style.display = 'none';
    document.getElementById('rejectionReasonDiv').style.display = 'none';
    document.getElementById('rejection_reason').value = '';
}

// Form validation
document.getElementById('approvalForm').addEventListener('submit', function(e) {
    const action = document.getElementById('action').value;
    if (!action) {
        e.preventDefault();
        alert('Please select Approve or Reject first.');
        return false;
    }

    if (action === 'reject') {
        const reason = document.getElementById('rejection_reason').value.trim();
        if (!reason) {
            e.preventDefault();
            alert('Please provide a rejection reason.');
            return false;
        }
    }

    return confirm('Are you sure you want to ' + action + ' this application? This action cannot be easily reversed.');
});
</script>
{% endblock %}
