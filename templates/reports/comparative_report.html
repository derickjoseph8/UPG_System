{% extends 'base.html' %}

{% block title %}{{ page_title }} - UPG Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-chart-line"></i> {{ page_title }}</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'reports:report_list' %}">Reports</a></li>
            <li class="breadcrumb-item active">Comparative Reports</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-balance-scale"></i> Compare Performance Across Periods</h5>
            </div>
            <div class="card-body">
                <form id="comparativeReportForm" method="get" action="{% url 'reports:download_comparative_report' %}">
                    <!-- Comparison Type -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Comparison Type *</label>
                        <div class="btn-group w-100" role="group">
                            {% for value, label in comparison_types %}
                            <input type="radio" class="btn-check" name="comparison_type" id="type_{{ value }}"
                                   value="{{ value }}" {% if forloop.first %}checked{% endif %} autocomplete="off">
                            <label class="btn btn-outline-primary" for="type_{{ value }}">
                                <i class="fas fa-{% if value == 'monthly' %}calendar-alt{% elif value == 'quarterly' %}calendar-week{% else %}calendar{% endif %} me-1"></i>
                                {{ label }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Metric Selection -->
                    <div class="mb-4">
                        <label for="metric" class="form-label fw-bold">Metric to Compare *</label>
                        <select class="form-select" id="metric" name="metric" required>
                            {% for value, label in metrics %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Year Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="year1" class="form-label fw-bold">Primary Year *</label>
                            <select class="form-select" id="year1" name="year1" required>
                                {% for year in years %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6" id="year2Container">
                            <label for="year2" class="form-label fw-bold">Comparison Year</label>
                            <select class="form-select" id="year2" name="year2">
                                {% for year in years %}
                                <option value="{{ year }}" {% if year == current_year|add:"-1" %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">For yearly comparison, this sets the range end</small>
                        </div>
                    </div>

                    <!-- Optional Village Filter -->
                    <div class="mb-4">
                        <label for="village" class="form-label">Filter by Village (Optional)</label>
                        <select class="form-select" id="village" name="village">
                            <option value="">All Villages</option>
                            {% for village in villages %}
                            <option value="{{ village.id }}">{{ village.name }} - {{ village.subcounty }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Output Format -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Output Format *</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="output_format" id="format_pdf" value="pdf" checked autocomplete="off">
                            <label class="btn btn-outline-danger" for="format_pdf">
                                <i class="fas fa-file-pdf me-1"></i> PDF (With Charts)
                            </label>
                            <input type="radio" class="btn-check" name="output_format" id="format_csv" value="csv" autocomplete="off">
                            <label class="btn btn-outline-success" for="format_csv">
                                <i class="fas fa-file-csv me-1"></i> CSV (Excel)
                            </label>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-download"></i> Generate Comparative Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Info Panel -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> About Comparative Reports</h6>
            </div>
            <div class="card-body">
                <p class="small">Compare performance metrics across different time periods to identify trends and measure progress.</p>

                <h6 class="mt-3">Comparison Types:</h6>
                <ul class="small mb-3">
                    <li><strong>Monthly:</strong> Compare each month between two years</li>
                    <li><strong>Quarterly:</strong> Compare quarters (Q1-Q4) between years</li>
                    <li><strong>Yearly:</strong> View trend across multiple years</li>
                </ul>

                <h6>Available Metrics:</h6>
                <ul class="small mb-0">
                    <li>Household Registrations</li>
                    <li>Program Enrollments & Graduations</li>
                    <li>Business Groups Formed</li>
                    <li>Savings Accumulated</li>
                    <li>Grants Disbursed</li>
                    <li>Training & Mentoring Activities</li>
                </ul>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Comparisons</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'reports:download_comparative_report' %}?comparison_type=monthly&metric=households&year1={{ current_year }}&year2={{ current_year|add:"-1" }}&output_format=pdf"
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-home"></i> Households {{ current_year }} vs {{ current_year|add:"-1" }}
                    </a>
                    <a href="{% url 'reports:download_comparative_report' %}?comparison_type=quarterly&metric=enrollments&year1={{ current_year }}&year2={{ current_year|add:"-1" }}&output_format=pdf"
                       class="btn btn-outline-success btn-sm">
                        <i class="fas fa-user-plus"></i> Enrollments by Quarter
                    </a>
                    <a href="{% url 'reports:download_comparative_report' %}?comparison_type=yearly&metric=graduations&year1={{ current_year }}&year2={{ current_year|add:"-4" }}&output_format=pdf"
                       class="btn btn-outline-info btn-sm">
                        <i class="fas fa-graduation-cap"></i> Graduations (5 Year Trend)
                    </a>
                    <a href="{% url 'reports:download_comparative_report' %}?comparison_type=monthly&metric=savings&year1={{ current_year }}&year2={{ current_year|add:"-1" }}&output_format=pdf"
                       class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-piggy-bank"></i> Savings Comparison
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const comparisonRadios = document.querySelectorAll('input[name="comparison_type"]');
    const year2Container = document.getElementById('year2Container');
    const year2Label = year2Container.querySelector('label');

    comparisonRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'yearly') {
                year2Label.textContent = 'End Year (Range)';
            } else {
                year2Label.textContent = 'Comparison Year';
            }
        });
    });
});
</script>
{% endblock %}
