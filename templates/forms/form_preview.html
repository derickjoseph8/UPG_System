{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .preview-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .field-row {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 12px 15px;
        margin-bottom: 8px;
    }
    .field-row:hover {
        border-color: #0d6efd;
        background: #f8f9ff;
    }
    .field-type-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        background: #e7f1ff;
        color: #0d6efd;
    }
    .required-badge {
        background: #f8d7da;
        color: #842029;
    }
    .choice-item {
        display: inline-block;
        background: #e9ecef;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        margin: 2px;
    }
    .metadata-field {
        background: #fff3cd;
        border-color: #ffc107;
    }
    .group-field {
        background: #d1e7dd;
        border-color: #198754;
    }
    .xlsform-json {
        max-height: 400px;
        overflow-y: auto;
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 13px;
    }
    .stats-card {
        text-align: center;
        padding: 15px;
    }
    .stats-card h3 {
        margin-bottom: 5px;
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-eye text-primary"></i> Form Preview</h2>
                    <p class="text-muted">Review your form structure before syncing to KoboToolbox</p>
                </div>
                <div>
                    <a href="{% url 'forms:template_builder' form_template.id %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Back to Builder
                    </a>
                    {% if form_template.sync_to_kobo %}
                    <button type="button" class="btn btn-success" onclick="confirmSync()">
                        <i class="fas fa-sync-alt"></i> Sync to KoboToolbox
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Form Info -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <h3>{{ survey_fields|length }}</h3>
                <p class="text-muted mb-0">Survey Fields</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <h3>{{ choice_lists|length }}</h3>
                <p class="text-muted mb-0">Choice Options</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <h3>v{{ settings.version|default:"1" }}</h3>
                <p class="text-muted mb-0">Form Version</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <h3>{{ settings.form_id|default:"N/A" }}</h3>
                <p class="text-muted mb-0">Form ID</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Survey Fields -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list-alt"></i> Survey Fields ({{ survey_fields|length }})</h5>
                </div>
                <div class="card-body">
                    {% if survey_fields %}
                    <div class="preview-section">
                        {% for field in survey_fields %}
                        <div class="field-row {% if field.type == 'start' or field.type == 'end' or field.type == 'today' or field.type == 'deviceid' or field.type == 'phonenumber' %}metadata-field{% elif field.type == 'begin_group' or field.type == 'end_group' %}group-field{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="field-type-badge">{{ field.type }}</span>
                                    {% if field.required == 'yes' %}
                                    <span class="field-type-badge required-badge ms-1">Required</span>
                                    {% endif %}
                                    <h6 class="mb-1 mt-2">{{ field.label|default:field.name }}</h6>
                                    <code class="text-muted small">{{ field.name }}</code>
                                </div>
                                <div class="text-end">
                                    {% if field.hint %}
                                    <small class="text-muted d-block"><i class="fas fa-info-circle"></i> {{ field.hint }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% if field.constraint %}
                            <div class="mt-2">
                                <small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Constraint: {{ field.constraint }}</small>
                            </div>
                            {% endif %}
                            {% if field.relevant %}
                            <div class="mt-1">
                                <small class="text-info"><i class="fas fa-code-branch"></i> Show when: {{ field.relevant }}</small>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-5">
                        <i class="fas fa-exclamation-circle fa-3x mb-3 d-block"></i>
                        No fields in this form. Go back to the builder to add fields.
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Choices & Settings -->
        <div class="col-md-4">
            <!-- Choices -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Choice Lists ({{ choice_lists|length }})</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% if choice_lists %}
                    {% regroup choice_lists by list_name as grouped_choices %}
                    {% for group in grouped_choices %}
                    <div class="mb-3">
                        <strong class="d-block mb-1">{{ group.grouper }}</strong>
                        <div>
                            {% for choice in group.list %}
                            <span class="choice-item">{{ choice.label }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted text-center mb-0">No choice fields in this form</p>
                    {% endif %}
                </div>
            </div>

            <!-- Settings -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog"></i> Form Settings</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Form Title:</td>
                            <td><strong>{{ settings.form_title|default:form_template.name }}</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Form ID:</td>
                            <td><code>{{ settings.form_id }}</code></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Version:</td>
                            <td>{{ settings.version }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Sync to Kobo:</td>
                            <td>
                                {% if form_template.sync_to_kobo %}
                                <span class="badge bg-success">Enabled</span>
                                {% else %}
                                <span class="badge bg-secondary">Disabled</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Status:</td>
                            <td>
                                <span class="badge bg-{% if form_template.status == 'active' %}success{% elif form_template.status == 'draft' %}warning{% else %}secondary{% endif %}">
                                    {{ form_template.get_status_display }}
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Raw JSON -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-code"></i> XLSForm JSON</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyJSON()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <div class="card-body p-0">
                    <pre class="xlsform-json mb-0" id="xlsformJson">{{ xlsform|safe }}</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync Confirmation Modal -->
<div class="modal fade" id="syncConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-sync-alt"></i> Confirm Sync to KoboToolbox</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You are about to sync <strong>{{ form_template.name }}</strong> to KoboToolbox.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> This will:
                    <ul class="mb-0 mt-2">
                        <li>Create or update the form in your KoboToolbox account</li>
                        <li>Deploy the form for data collection</li>
                        <li>Upload any media files attached to the form</li>
                    </ul>
                </div>
                <p class="text-muted small">Make sure you have reviewed all fields above before proceeding.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="syncToKobo()">
                    <i class="fas fa-sync-alt"></i> Yes, Sync Now
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmSync() {
    new bootstrap.Modal(document.getElementById('syncConfirmModal')).show();
}

function syncToKobo() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';

    fetch("{% url 'forms:kobo_manual_sync' form_template.id %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Form synced successfully to KoboToolbox!');
            window.location.href = "{% url 'forms:template_builder' form_template.id %}";
        } else {
            alert('Sync failed: ' + data.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> Yes, Sync Now';
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Yes, Sync Now';
    });
}

function copyJSON() {
    const json = document.getElementById('xlsformJson').textContent;
    navigator.clipboard.writeText(json).then(() => {
        alert('JSON copied to clipboard!');
    });
}

// Format JSON for display
document.addEventListener('DOMContentLoaded', function() {
    const jsonElement = document.getElementById('xlsformJson');
    try {
        const data = JSON.parse(jsonElement.textContent);
        jsonElement.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
        // Already formatted or not valid JSON
    }
});
</script>
{% endblock %}
