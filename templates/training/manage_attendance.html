<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - UPG Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container-fluid p-4">
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-users"></i> {{ page_title }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'training:training_list' %}">Training Sessions</a></li>
                <li class="breadcrumb-item"><a href="{% url 'training:training_details' training.id %}">{{ training.name }}</a></li>
                <li class="breadcrumb-item active">Attendance</li>
            </ol>
        </nav>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'training:edit_training' training.id %}" class="btn btn-outline-primary">
            <i class="fas fa-edit"></i> Edit Training
        </a>
        <a href="{% url 'training:training_details' training.id %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Training
        </a>
    </div>
</div>

<!-- Training Info Card -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <div class="row">
            <div class="col-md-8">
                <h5 class="mb-0"><i class="fas fa-chalkboard-teacher me-2"></i>{{ training.name }}</h5>
                <small>Module: {{ training.module_id }} â€¢ Status: {{ training.get_status_display }}</small>
            </div>
            <div class="col-md-4 text-end">
                <span class="badge bg-light text-dark fs-6">{{ training.start_date|date:"M d, Y"|default:"Date TBD" }}</span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <strong>Location:</strong><br>
                <span class="text-muted">{{ training.location|default:"Not specified" }}</span>
            </div>
            <div class="col-md-3">
                <strong>Assigned Mentor:</strong><br>
                <span class="text-muted">{{ training.assigned_mentor.get_full_name|default:"Not assigned" }}</span>
            </div>
            <div class="col-md-3">
                <strong>Max Capacity:</strong><br>
                <span class="text-muted">{{ training.max_households }} households</span>
            </div>
            <div class="col-md-3">
                <strong>Duration:</strong><br>
                <span class="text-muted">{{ training.duration_hours|default:"Not set" }} hours</span>
            </div>
        </div>
    </div>
</div>

<!-- Date Selector for Daily Attendance -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h6 class="mb-0"><i class="fas fa-calendar-day me-2"></i>Select Training Date</h6>
                <small class="text-muted">Select a past date to mark retroactive attendance</small>
            </div>
            <div class="col-md-8">
                <form method="get" class="d-flex gap-2 align-items-center">
                    <!-- Dropdown for existing training dates -->
                    <select class="form-select form-select-sm" id="date-selector" name="date" style="max-width: 250px;">
                        {% for date in training_dates %}
                        <option value="{{ date|date:'Y-m-d' }}" {% if date == selected_date %}selected{% endif %}>
                            {{ date|date:"l, F d, Y" }}
                        </option>
                        {% endfor %}
                        <option value="custom">-- Enter Custom Date --</option>
                    </select>
                    <!-- Custom date input (hidden by default) -->
                    <input type="date" class="form-control form-control-sm" id="custom-date-input"
                           name="custom_date" style="display: none; max-width: 180px;"
                           value="{{ selected_date|date:'Y-m-d' }}">
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="fas fa-calendar-check"></i> Go
                    </button>
                    <a href="?date={{ selected_date|date:'Y-m-d' }}" class="btn btn-sm btn-outline-secondary" title="Refresh">
                        <i class="fas fa-sync"></i>
                    </a>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-primary shadow-sm">
            <div class="card-body text-center">
                <div class="display-6 text-primary mb-2">
                    <i class="fas fa-users"></i>
                </div>
                <h4 class="text-primary">{{ total_enrolled }}</h4>
                <p class="text-muted mb-0">Enrolled ({{ selected_date|date:"M d" }})</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success shadow-sm">
            <div class="card-body text-center">
                <div class="display-6 text-success mb-2">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h4 class="text-success">{{ present_count }}</h4>
                <p class="text-muted mb-0">Present</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning shadow-sm">
            <div class="card-body text-center">
                <div class="display-6 text-warning mb-2">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h4 class="text-warning">{{ absent_count }}</h4>
                <p class="text-muted mb-0">Absent</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info shadow-sm">
            <div class="card-body text-center">
                <div class="display-6 text-info mb-2">
                    <i class="fas fa-percentage"></i>
                </div>
                <h4 class="text-info">{{ attendance_rate }}%</h4>
                <p class="text-muted mb-0">Attendance Rate</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        {% if attendances.count == 0 %}
        <!-- No Households Enrolled -->
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-users text-muted" style="font-size: 4rem;"></i>
                </div>
                <h4 class="text-muted mb-3">No households enrolled</h4>
                <p class="text-muted mb-4">This training session has no households enrolled yet. Click the button below to add the first household.</p>
                <button type="button" class="btn btn-primary btn-lg" id="add-first-household-btn"
                        onclick="console.log('Inline click triggered'); $('#household-selection-form').slideDown(); loadAvailableHouseholds();">
                    <i class="fas fa-plus me-2"></i>Add First Household
                </button>
            </div>
        </div>
        {% else %}
        <!-- Attendance Management -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Attendance Management</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success btn-sm" id="mark-all-present">
                        <i class="fas fa-check-double"></i> Mark All Present
                    </button>
                    <button type="button" class="btn btn-warning btn-sm" id="mark-all-absent">
                        <i class="fas fa-times"></i> Mark All Absent
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" id="add-household-btn"
                            onclick="console.log('Regular add button inline click'); $('#household-selection-form').slideDown(); loadAvailableHouseholds();">
                        <i class="fas fa-plus"></i> Add Household
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30%;">Household</th>
                                <th style="width: 20%;">Village</th>
                                <th style="width: 15%;">Training Date</th>
                                <th style="width: 20%;">Attendance</th>
                                <th style="width: 15%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-tbody">
                            {% for attendance in attendances %}
                            <tr data-attendance-id="{{ attendance.id }}" class="{% if attendance.attendance %}table-light{% endif %}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            {% if attendance.attendance %}
                                            <i class="fas fa-check-circle text-success fs-5"></i>
                                            {% else %}
                                            <i class="fas fa-times-circle text-warning fs-5"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <strong>{{ attendance.household.name }}</strong><br>
                                            <small class="text-muted">
                                                <i class="fas fa-phone me-1"></i>{{ attendance.household.phone_number }}
                                            </small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">
                                        {{ attendance.household.village.name }}
                                    </span>
                                </td>
                                <td>
                                    <small>{{ attendance.training_date|date:"M d, Y" }}</small>
                                </td>
                                <td>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input attendance-toggle" type="checkbox"
                                               data-attendance-id="{{ attendance.id }}"
                                               {% if attendance.attendance %}checked{% endif %}
                                               style="transform: scale(1.2);">
                                        <label class="form-check-label fw-medium attendance-label">
                                            {% if attendance.attendance %}
                                            <span class="text-success">Present</span>
                                            {% else %}
                                            <span class="text-warning">Absent</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                    {% if attendance.marked_by %}
                                    <small class="text-muted d-block mt-1">
                                        Marked by: {{ attendance.marked_by.get_full_name }}<br>
                                        {% if attendance.attendance_marked_at %}
                                        {{ attendance.attendance_marked_at|date:"M d, Y H:i" }}
                                        {% endif %}
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                                data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item text-danger remove-attendance" href="#"
                                                   data-attendance-id="{{ attendance.id }}">
                                                    <i class="fas fa-trash me-2"></i>Remove from Training
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Household Selection Form (Hidden by default) - BULK SELECT -->
        <div class="card mt-3" id="household-selection-form" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-users me-2"></i>Add Participants to Training</h6>
                <span class="badge bg-info" id="selected-count">0 selected</span>
            </div>
            <div class="card-body">
                <form id="add-household-form">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="attendance-date" class="form-label">Training Date</label>
                            <input type="date" class="form-control" id="attendance-date" name="training_date"
                                   value="{{ selected_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Search Households</label>
                            <input type="text" class="form-control" id="household-search" placeholder="Type to filter...">
                        </div>
                    </div>

                    <!-- Select All / Deselect All -->
                    <div class="mb-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="select-all-btn">
                            <i class="fas fa-check-double"></i> Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-btn">
                            <i class="fas fa-times"></i> Deselect All
                        </button>
                        <span class="ms-3 text-muted small">Available slots: <strong id="available-slots">{{ training.available_slots }}</strong></span>
                    </div>

                    <!-- Household Checkboxes Container -->
                    <div id="household-checkboxes" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading available households...
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary" id="submit-add-household">
                            <i class="fas fa-plus"></i> Add Selected (<span id="submit-count">0</span>)
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancel-add-household">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6><i class="fas fa-bolt"></i> Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-success" id="save-attendance">
                        <i class="fas fa-check-circle"></i> Changes Auto-Save
                    </button>
                    <a href="{% url 'training:edit_training' training.id %}" class="btn btn-outline-primary">
                        <i class="fas fa-edit"></i> Edit Training Details
                    </a>
                    {% if training.status == 'planned' %}
                    <a href="{% url 'training:start_training' training.id %}" class="btn btn-outline-warning">
                        <i class="fas fa-play"></i> Start Training
                    </a>
                    {% endif %}
                    {% if training.status == 'active' %}
                    <a href="{% url 'training:complete_training' training.id %}" class="btn btn-outline-info">
                        <i class="fas fa-check"></i> Complete Training
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Mentor Instructions -->
        {% if user.role == 'mentor' and training.assigned_mentor == user %}
        <div class="card shadow-sm mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-user-check me-2"></i>Mentor Instructions</h6>
            </div>
            <div class="card-body">
                <p class="small mb-0">As the assigned mentor for this training, you can mark attendance and manage household enrollment. Use the toggles to mark each household as present or absent.</p>
            </div>
        </div>
        {% endif %}

        <!-- Training Progress -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6><i class="fas fa-chart-line"></i> Training Progress</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Enrollment Progress</small>
                        <small class="text-muted">{{ total_enrolled }}/{{ training.max_households }}</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar"
                             style="width: {% widthratio total_enrolled training.max_households 100 %}%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Attendance Rate</small>
                        <small class="text-muted">{{ attendance_rate }}%</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: {{ attendance_rate }}%"></div>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-4">
                        <div class="text-primary fw-bold">{{ total_enrolled }}</div>
                        <small class="text-muted">Enrolled</small>
                    </div>
                    <div class="col-4">
                        <div class="text-success fw-bold">{{ present_count }}</div>
                        <small class="text-muted">Present</small>
                    </div>
                    <div class="col-4">
                        <div class="text-warning fw-bold">{{ absent_count }}</div>
                        <small class="text-muted">Absent</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h6><i class="fas fa-history"></i> Recent Activity</h6>
            </div>
            <div class="card-body">
                {% if attendances %}
                <div class="timeline">
                    {% for attendance in attendances|slice:":5" %}
                    {% if attendance.attendance_marked_at %}
                    <div class="d-flex mb-2">
                        <div class="me-2">
                            {% if attendance.attendance %}
                            <i class="fas fa-check-circle text-success"></i>
                            {% else %}
                            <i class="fas fa-times-circle text-warning"></i>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <small>
                                <strong>{{ attendance.household.name }}</strong> marked
                                {% if attendance.attendance %}present{% else %}absent{% endif %}
                                <br>
                                <span class="text-muted">{{ attendance.attendance_marked_at|timesince }} ago</span>
                            </small>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-0">No recent activity</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Global variables and functions
const trainingId = {{ training.id }};

// CSRF token setup for AJAX
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

// Make loadAvailableHouseholds globally available
function loadAvailableHouseholds() {
    console.log('Loading available households for training ID:', trainingId);

    // Check if the form exists
    const $form = $('#household-selection-form');
    const $select = $('#household-select');

    console.log('Household selection form found:', $form.length > 0);
    console.log('Household select found:', $select.length > 0);

    if ($form.length === 0) {
        console.error('Household selection form not found!');
        return;
    }

    $.ajax({
        url: '/training/' + trainingId + '/available-households/',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            console.log('Received household data:', data);
            const container = $('#household-checkboxes');
            container.empty();

            if (data.success && data.households) {
                if (data.households.length === 0) {
                    container.html('<div class="text-center py-3 text-muted">No available households to add</div>');
                    console.log('No households available');
                } else {
                    // Store households globally for search filtering
                    window.availableHouseholds = data.households;

                    // Render checkboxes
                    renderHouseholdCheckboxes(data.households);
                    console.log('Added', data.households.length, 'households as checkboxes');
                }
            } else {
                console.error('Failed to load households:', data);
                container.html('<div class="text-danger">Error loading households</div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX error loading households:', status, error);
            const container = $('#household-checkboxes');
            container.html('<div class="text-danger">Error loading households: ' + error + '</div>');
        }
    });
}

// Render household checkboxes
function renderHouseholdCheckboxes(households) {
    const container = $('#household-checkboxes');
    container.empty();

    if (households.length === 0) {
        container.html('<div class="text-center py-3 text-muted">No matching households</div>');
        return;
    }

    // Group by village
    const byVillage = {};
    households.forEach(function(h) {
        if (!byVillage[h.village]) byVillage[h.village] = [];
        byVillage[h.village].push(h);
    });

    // Render grouped checkboxes
    Object.keys(byVillage).sort().forEach(function(village) {
        container.append(`<div class="fw-bold text-primary mt-2 mb-1">${village}</div>`);
        byVillage[village].forEach(function(household) {
            container.append(`
                <div class="form-check">
                    <input class="form-check-input household-checkbox" type="checkbox"
                           name="household_ids[]" value="${household.id}" id="hh-${household.id}">
                    <label class="form-check-label" for="hh-${household.id}">
                        ${household.name}
                        ${household.phone ? '<small class="text-muted">(' + household.phone + ')</small>' : ''}
                    </label>
                </div>
            `);
        });
    });

    updateSelectedCount();
}

// Update selected count
function updateSelectedCount() {
    const count = $('.household-checkbox:checked').length;
    $('#selected-count').text(count + ' selected');
    $('#submit-count').text(count);
}

$(document).ready(function() {
    console.log('Document ready, training ID:', trainingId);
    console.log('jQuery version:', $.fn.jquery);
    console.log('Add first household button found:', $('#add-first-household-btn').length);
    console.log('Add household button found:', $('#add-household-btn').length);

    // Handle custom date selector
    $('#date-selector').change(function() {
        if ($(this).val() === 'custom') {
            $('#custom-date-input').show().focus();
            $(this).attr('name', ''); // Remove name so it doesn't conflict
        } else {
            $('#custom-date-input').hide();
            $(this).attr('name', 'date');
        }
    });

    // Handle form submission with custom date
    $('#date-selector').closest('form').on('submit', function(e) {
        if ($('#date-selector').val() === 'custom') {
            const customDate = $('#custom-date-input').val();
            if (!customDate) {
                e.preventDefault();
                alert('Please select a date');
                return false;
            }
            // Set the date parameter from custom input
            $('#custom-date-input').attr('name', 'date');
        }
    });

    // Use event delegation to ensure buttons work even if dynamically added
    $(document).on('click', '#add-first-household-btn, #add-household-btn', function() {
        console.log('Add household button clicked');
        $('#household-selection-form').slideDown();
        loadAvailableHouseholds();
    });

    // Also bind directly for immediate availability
    $('#add-first-household-btn, #add-household-btn').on('click', function() {
        console.log('Direct click handler: Add household button clicked');
        $('#household-selection-form').slideDown();
        loadAvailableHouseholds();
    });

    // Add a test function to verify button is accessible
    setTimeout(function() {
        const $firstBtn = $('#add-first-household-btn');
        const $regularBtn = $('#add-household-btn');

        console.log('Button accessibility test:');
        console.log('First household button:', $firstBtn.length > 0 ? 'Found' : 'Not found');
        console.log('Regular add button:', $regularBtn.length > 0 ? 'Found' : 'Not found');

        if ($firstBtn.length > 0) {
            console.log('First household button visible:', $firstBtn.is(':visible'));
            console.log('First household button enabled:', !$firstBtn.is(':disabled'));
        }

        if ($regularBtn.length > 0) {
            console.log('Regular add button visible:', $regularBtn.is(':visible'));
            console.log('Regular add button enabled:', !$regularBtn.is(':disabled'));
        }
    }, 1000);

    // Hide add household form
    $('#cancel-add-household').click(function() {
        $('#household-selection-form').slideUp();
        $('#add-household-form')[0].reset();
    });


    // Select All button
    $('#select-all-btn').click(function() {
        $('.household-checkbox:visible').prop('checked', true);
        updateSelectedCount();
    });

    // Deselect All button
    $('#deselect-all-btn').click(function() {
        $('.household-checkbox').prop('checked', false);
        updateSelectedCount();
    });

    // Update count when checkboxes change
    $(document).on('change', '.household-checkbox', function() {
        updateSelectedCount();
    });

    // Search/filter households
    $('#household-search').on('input', function() {
        const query = $(this).val().toLowerCase();
        if (window.availableHouseholds) {
            const filtered = window.availableHouseholds.filter(function(h) {
                return h.name.toLowerCase().includes(query) ||
                       h.village.toLowerCase().includes(query) ||
                       (h.phone && h.phone.includes(query));
            });
            renderHouseholdCheckboxes(filtered);
        }
    });

    // Add households to training (bulk)
    $('#add-household-form').submit(function(e) {
        e.preventDefault();
        console.log('Form submitted');

        const selectedIds = $('.household-checkbox:checked').map(function() {
            return $(this).val();
        }).get();

        if (selectedIds.length === 0) {
            alert('Please select at least one household');
            return;
        }

        const trainingDate = $('#attendance-date').val();
        if (!trainingDate) {
            alert('Please select a training date');
            return;
        }

        const submitBtn = $('#submit-add-household');
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Adding ' + selectedIds.length + '...');

        $.ajax({
            url: '/training/' + trainingId + '/add-household/',
            type: 'POST',
            data: {
                'household_ids[]': selectedIds,
                'training_date': trainingDate,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            dataType: 'json',
            traditional: true,
            success: function(data) {
                console.log('Response received:', data);
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error adding households:', status, error);
                alert('Error adding households: ' + error);
            },
            complete: function() {
                submitBtn.prop('disabled', false).html('<i class="fas fa-plus"></i> Add Selected (<span id="submit-count">0</span>)');
                updateSelectedCount();
            }
        });
    });

    // Toggle attendance - with explicit CSRF token
    $('.attendance-toggle').change(function() {
        const attendanceId = $(this).data('attendance-id');
        const isPresent = $(this).is(':checked');
        const row = $(this).closest('tr');
        const label = $(this).siblings('.attendance-label');
        const icon = row.find('td:first i');
        const toggle = $(this);

        // Disable toggle while saving
        toggle.prop('disabled', true);

        $.ajax({
            url: '/training/attendance/' + attendanceId + '/toggle/',
            type: 'POST',
            data: {
                attendance: isPresent ? 'true' : 'false',
                csrfmiddlewaretoken: csrftoken
            },
            success: function(data) {
                if (data.success) {
                    // Update label and styling
                    if (isPresent) {
                        label.html('<span class="text-success">Present</span>');
                        row.addClass('table-light');
                        icon.removeClass('fa-times-circle text-warning').addClass('fa-check-circle text-success');
                    } else {
                        label.html('<span class="text-warning">Absent</span>');
                        row.removeClass('table-light');
                        icon.removeClass('fa-check-circle text-success').addClass('fa-times-circle text-warning');
                    }

                    // Show save indicator
                    $('#save-attendance').html('<i class="fas fa-check"></i> Saved!').removeClass('btn-outline-success').addClass('btn-success');
                    setTimeout(function() {
                        $('#save-attendance').html('<i class="fas fa-save"></i> All Changes Saved').removeClass('btn-success').addClass('btn-outline-success');
                    }, 2000);

                    // Update statistics without full page reload
                    updateStatistics();
                } else {
                    alert('Error: ' + (data.message || 'Failed to update attendance'));
                    // Revert toggle
                    toggle.prop('checked', !isPresent);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error updating attendance:', status, error);
                console.error('Response:', xhr.responseText);
                let errorMsg = 'Error updating attendance. ';
                if (xhr.status === 403) {
                    errorMsg += 'Permission denied. Please refresh the page and try again.';
                } else if (xhr.status === 404) {
                    errorMsg += 'Attendance record not found.';
                } else if (xhr.status === 500) {
                    errorMsg += 'Server error. Please try again.';
                } else {
                    errorMsg += error || 'Unknown error occurred.';
                }
                alert(errorMsg);
                // Revert toggle
                toggle.prop('checked', !isPresent);
            },
            complete: function() {
                toggle.prop('disabled', false);
            }
        });
    });

    // Function to update statistics without full reload
    function updateStatistics() {
        let present = 0;
        let absent = 0;
        $('.attendance-toggle').each(function() {
            if ($(this).is(':checked')) {
                present++;
            } else {
                absent++;
            }
        });
        const total = present + absent;
        const rate = total > 0 ? Math.round((present * 100) / total) : 0;

        // Update stat cards
        $('.card.border-success h4').text(present);
        $('.card.border-warning h4').text(absent);
        $('.card.border-info h4').text(rate + '%');

        // Update progress bar
        $('.progress-bar.bg-success').css('width', rate + '%');
    }

    // Mark all present
    $('#mark-all-present').click(function() {
        if (confirm('Mark all participants as present for this date?')) {
            const uncheckedToggles = $('.attendance-toggle:not(:checked)');
            uncheckedToggles.each(function(index) {
                const toggle = $(this);
                // Stagger the requests to avoid overwhelming the server
                setTimeout(function() {
                    toggle.prop('checked', true).trigger('change');
                }, index * 200);
            });
        }
    });

    // Mark all absent
    $('#mark-all-absent').click(function() {
        if (confirm('Mark all participants as absent for this date?')) {
            const checkedToggles = $('.attendance-toggle:checked');
            checkedToggles.each(function(index) {
                const toggle = $(this);
                // Stagger the requests to avoid overwhelming the server
                setTimeout(function() {
                    toggle.prop('checked', false).trigger('change');
                }, index * 200);
            });
        }
    });

    // Remove attendance
    $('.remove-attendance').click(function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to remove this household from the training?')) {
            const attendanceId = $(this).data('attendance-id');
            const row = $('tr[data-attendance-id="' + attendanceId + '"]');

            $.ajax({
                url: '/training/attendance/' + attendanceId + '/remove/',
                type: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function(data) {
                    if (data.success) {
                        // Remove row with animation
                        row.fadeOut(300, function() {
                            $(this).remove();
                            updateStatistics();
                        });
                    } else {
                        alert('Error: ' + (data.message || 'Failed to remove household'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error removing household:', error);
                    alert('Error removing household. Please try again.');
                }
            });
        }
    });

    // Save attendance - show auto-save message (attendance is saved automatically on toggle)
    $('#save-attendance').click(function() {
        $(this).html('<i class="fas fa-check"></i> All Changes Auto-Saved!').removeClass('btn-outline-success').addClass('btn-success');
        setTimeout(function() {
            $('#save-attendance').html('<i class="fas fa-save"></i> Changes Auto-Save').removeClass('btn-success').addClass('btn-outline-success');
        }, 2000);
    });
});
</script>
</div>
</body>
</html>