{% extends 'base.html' %}

{% block title %}{{ page_title }} - UPG Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-piggy-bank"></i> {{ savings_group.name }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'savings_groups:savings_list' %}">Savings Groups</a></li>
                <li class="breadcrumb-item active">{{ savings_group.name }}</li>
            </ol>
        </nav>
    </div>
    <div class="btn-group">
        <a href="{% url 'savings_groups:savings_group_edit' savings_group.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-edit"></i> Edit
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Group Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Savings Group Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Group Name:</strong> {{ savings_group.name }}</p>
                        <p><strong>Formation Date:</strong> {{ savings_group.formation_date|date:"M d, Y"|default:"Not set" }}</p>
                        <p><strong>Meeting Day:</strong> {{ savings_group.meeting_day|default:"Not set" }}</p>
                        <p><strong>Meeting Location:</strong> {{ savings_group.meeting_location|default:"Not set" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Target Members:</strong> {{ savings_group.target_members }}</p>
                        <p><strong>Total Members:</strong> {{ savings_group.total_members }}</p>
                        <p><strong>Savings Frequency:</strong> {{ savings_group.get_savings_frequency_display }}</p>
                        <p><strong>Status:</strong>
                            <span class="badge bg-{% if savings_group.is_active %}success{% else %}secondary{% endif %}">
                                {% if savings_group.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </p>
                    </div>
                </div>

                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-info mb-0">
                            <h5 class="mb-2"><i class="fas fa-coins"></i> Total Savings to Date</h5>
                            <h3 class="mb-0">KES {{ savings_group.savings_to_date|floatformat:2 }}</h3>
                        </div>
                    </div>
                </div>

                {% if savings_group.facilitator %}
                <hr>
                <p><strong>Facilitator:</strong> {{ savings_group.facilitator.get_full_name|default:savings_group.facilitator.username }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Business Groups -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-briefcase"></i> Business Groups</h5>
                <a href="{% url 'savings_groups:add_business_group' savings_group.pk %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus"></i> Add Business Group
                </a>
            </div>
            <div class="card-body">
                {% if savings_group.business_groups.all %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Group Name</th>
                                    <th>Business Type</th>
                                    <th>Members</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bg in savings_group.business_groups.all %}
                                <tr>
                                    <td><a href="{% url 'business_groups:group_detail' bg.pk %}">{{ bg.name }}</a></td>
                                    <td>{{ bg.business_type|default:"-" }}</td>
                                    <td>{{ bg.members.count }}</td>
                                    <td>
                                        <a href="{% url 'savings_groups:remove_business_group' savings_group.pk bg.pk %}"
                                           class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-times"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No business groups associated yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Individual Members -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-users"></i> Active Members ({{ current_members }})</h5>
                <a href="{% url 'savings_groups:add_member' savings_group.pk %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-user-plus"></i> Add Member
                </a>
            </div>
            <div class="card-body">
                {% if active_members %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Household</th>
                                    <th>Role</th>
                                    <th>Joined Date</th>
                                    <th>Total Savings</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in active_members %}
                                <tr>
                                    <td>{{ member.household }}</td>
                                    <td>
                                        <span class="badge bg-{% if member.role == 'chairperson' %}warning text-dark{% elif member.role == 'secretary' %}info{% elif member.role == 'treasurer' %}success{% else %}secondary{% endif %}">
                                            {{ member.get_role_display }}
                                        </span>
                                    </td>
                                    <td>{{ member.joined_date|date:"M d, Y" }}</td>
                                    <td>KES {{ member.total_savings|floatformat:2 }}</td>
                                    <td>
                                        <a href="{% url 'savings_groups:remove_member' savings_group.pk member.pk %}"
                                           class="btn btn-sm btn-outline-danger" title="Remove Member">
                                            <i class="fas fa-user-minus"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No active members yet.</p>
                {% endif %}

                <!-- Removed/Inactive Members -->
                {% if inactive_members %}
                <hr>
                <h6 class="text-muted mt-4"><i class="fas fa-user-slash"></i> Removed Members ({{ inactive_members.count }})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-secondary">
                        <thead>
                            <tr>
                                <th>Household</th>
                                <th>Role</th>
                                <th>Joined Date</th>
                                <th>Total Savings</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in inactive_members %}
                            <tr class="text-muted">
                                <td>{{ member.household }}</td>
                                <td>{{ member.get_role_display }}</td>
                                <td>{{ member.joined_date|date:"M d, Y" }}</td>
                                <td>KES {{ member.total_savings|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Group Officials -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h6><i class="fas fa-user-tie"></i> Group Officials</h6>
            </div>
            <div class="card-body">
                {% with chairperson=savings_group.bsg_members.all|dictsort:"role"|first %}
                {% for member in savings_group.bsg_members.all %}
                    {% if member.role == 'chairperson' %}
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div>
                            <strong>Chairperson</strong><br>
                            <small>{{ member.household }}</small>
                        </div>
                    </div>
                    {% endif %}
                    {% if member.role == 'secretary' %}
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                            <i class="fas fa-pen"></i>
                        </div>
                        <div>
                            <strong>Secretary</strong><br>
                            <small>{{ member.household }}</small>
                        </div>
                    </div>
                    {% endif %}
                    {% if member.role == 'treasurer' %}
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div>
                            <strong>Treasurer</strong><br>
                            <small>{{ member.household }}</small>
                        </div>
                    </div>
                    {% endif %}
                {% empty %}
                    <p class="text-muted mb-0">No officials assigned yet.</p>
                {% endfor %}
                {% endwith %}
                {% if not savings_group.bsg_members.all %}
                    <p class="text-muted mb-0">No officials assigned yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Savings Actions -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h6><i class="fas fa-coins"></i> Savings Management</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'savings_groups:record_savings' savings_group.pk %}" class="btn btn-success">
                        <i class="fas fa-hand-holding-usd"></i> Record Savings
                    </a>
                    <a href="{% url 'savings_groups:savings_report' savings_group.pk %}" class="btn btn-outline-success">
                        <i class="fas fa-chart-line"></i> View Savings Report
                    </a>
                    <a href="{% url 'savings_groups:export_savings_data' savings_group.pk %}" class="btn btn-outline-success">
                        <i class="fas fa-file-csv"></i> Export Savings Data
                    </a>
                </div>
            </div>
        </div>

        <!-- Loan Management -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h6><i class="fas fa-hand-holding-usd"></i> Loan Management</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'savings_groups:loan_list' savings_group.pk %}" class="btn btn-primary">
                        <i class="fas fa-list"></i> View All Loans
                    </a>
                    <a href="{% url 'savings_groups:issue_loan' savings_group.pk %}" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> Issue New Loan
                    </a>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h6><i class="fas fa-bolt"></i> Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'savings_groups:savings_group_edit' savings_group.pk %}" class="btn btn-outline-primary">
                        <i class="fas fa-edit"></i> Edit Group
                    </a>
                    <a href="{% url 'savings_groups:add_member' savings_group.pk %}" class="btn btn-outline-success">
                        <i class="fas fa-user-plus"></i> Add Individual Member
                    </a>
                    <a href="{% url 'savings_groups:add_business_group' savings_group.pk %}" class="btn btn-outline-info">
                        <i class="fas fa-briefcase"></i> Add Business Group
                    </a>
                </div>
            </div>
        </div>

        <!-- Group Statistics -->
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-chart-bar"></i> Statistics</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Members:</span>
                    <strong>{{ current_members }} / {{ savings_group.target_members }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Meetings:</span>
                    <strong>0</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Active Loans:</span>
                    <strong>0</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Completion Rate:</span>
                    <strong>{{ membership_percentage }}%</strong>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}